<div class="ticket-purchase">
  <div class="container py-4">
    <div class="page-header">
      <h1><i class="bi bi-ticket-perforated me-2"></i>Comprar Entradas</h1>
    </div>

    <div class="purchase-container">
      <div *ngIf="isLoading" class="loading-state">
        <div class="spinner-border" role="status">
          <span class="visually-hidden">Cargando detalles...</span>
        </div>
        <p class="mt-2">Cargando detalles del evento...</p>
      </div>

      <div *ngIf="error" class="error-message">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>{{ error }}
        <button type="button" class="btn" (click)="ngOnInit()">
          <i class="bi bi-arrow-clockwise me-1"></i>Reintentar
        </button>
      </div>

      <ng-container *ngIf="!isLoading && !error">
        <div *ngIf="event$ | async as event" class="event-details">
          <h2><i class="bi bi-calendar-event me-2"></i>{{ event.name }}</h2>
          <p *ngIf="event.description"><i class="bi bi-file-text me-2"></i>{{ event.description }}</p>
          <p *ngIf="event.startDateTime"><i class="bi bi-clock me-2"></i>{{ event.startDateTime | date: 'fullDate':'':'es-AR' }} a las {{ event.startDateTime | date: 'HH:mm':'':'es-AR' }} hs.</p>
          <p *ngIf="event.location"><i class="bi bi-geo-alt me-2"></i>{{ event.location }}</p>
        </div>

        <div class="filter-card">
          <div class="card-body">
            <h3 class="card-title">
              <i class="bi bi-grid-3x2 me-2"></i>Secciones Disponibles
            </h3>
            
            <div *ngIf="sectionOffers.length === 0 && !isLoading" class="empty-state">
              <div class="alert alert-warning text-center">
                <i class="bi bi-exclamation-circle me-2"></i>
                No hay secciones disponibles para compra en este evento actualmente.
              </div>
            </div>

            <div class="row" *ngIf="sectionOffers.length > 0">
              <div class="col-md-6 col-lg-4 mb-4" *ngFor="let offer of sectionOffers">
                <div class="ticket-type-item">
                  <h4>{{ offer.sectionName }}</h4>
                  
                  <!-- Mostrar precios disponibles para esta sección -->
                  <div *ngIf="offer.ticketPrices && offer.ticketPrices.length > 0" class="ticket-prices">
                    <div *ngFor="let ticketPrice of offer.ticketPrices" class="price-option mb-2">
                      <div class="d-flex justify-content-between align-items-center">
                        <span class="ticket-type">{{ ticketPrice.ticketType }}</span>
                        <span class="price">{{ ticketPrice.price | currency:offer.currency:'symbol':'1.2-2' }}</span>
                      </div>
                      <small class="text-muted">{{ ticketPrice.availableQuantity }} disponibles</small>
                    </div>
                  </div>
                  
                  <!-- Si no hay precios definidos -->
                  <div *ngIf="!offer.ticketPrices || offer.ticketPrices.length === 0" class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    No hay precios definidos para esta sección
                  </div>
                  
                  <p class="availability">
                    <i class="bi bi-people me-1"></i>{{ offer.availableTickets }} entradas disponibles
                  </p>
                  
                  <div class="quantity-selector" *ngIf="offer.availableTickets > 0 && offer.ticketPrices && offer.ticketPrices.length > 0">
                    <!-- Selector de tipo de ticket -->
                    <div class="mb-2">
                      <label for="ticketType-{{offer.sectionId}}">Tipo de entrada:</label>
                      <select 
                        class="form-select" 
                        id="ticketType-{{offer.sectionId}}" 
                        #ticketTypeSelect>
                        <option value="">Seleccione tipo</option>
                        <option *ngFor="let ticketPrice of offer.ticketPrices" 
                                [value]="ticketPrice.ticketPriceId"
                                [attr.data-price]="ticketPrice.price"
                                [attr.data-type]="ticketPrice.ticketType"
                                [attr.data-available]="ticketPrice.availableQuantity">
                          {{ ticketPrice.ticketType }} - {{ ticketPrice.price | currency:offer.currency:'symbol':'1.2-2' }}
                        </option>
                      </select>
                    </div>
                    
                    <div class="mb-2">
                      <label for="quantity-{{offer.sectionId}}">Cantidad:</label>
                      <input 
                        class="form-control" 
                        style="width: 80px; text-align: center;" 
                        type="number" 
                        id="quantity-{{offer.sectionId}}" 
                        #quantityInput 
                        value="1" 
                        min="1" 
                        [max]="getMaxQuantityForSelectedTicketType(offer, ticketTypeSelect.value)">
                    </div>
                    
                    <button 
                      type="button"
                      class="btn btn-primary" 
                      [disabled]="!ticketTypeSelect.value"
                      (click)="addTicketForSectionAndType(offer, ticketTypeSelect, quantityInput.valueAsNumber || 1)">
                      <i class="bi bi-cart-plus me-1"></i>Agregar al Carrito
                    </button>
                  </div>
                  
                  <div *ngIf="offer.availableTickets === 0" class="alert alert-danger text-center mt-3">
                    <i class="bi bi-exclamation-triangle me-2"></i>Agotado
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <form [formGroup]="purchaseForm" (ngSubmit)="onSubmit()">
          <div formArrayName="attendeeTickets" class="attendee-tickets" *ngIf="attendeeTickets.controls.length > 0">
            <h3>
              <i class="bi bi-cart me-2"></i>Tu Carrito ({{ attendeeTickets.controls.length }} 
              {{ attendeeTickets.controls.length === 1 ? 'Entrada' : 'Entradas' }})
            </h3>
            
            <div *ngFor="let ticketCtrl of attendeeTickets.controls; let i = index" [formGroupName]="i" class="attendee-ticket-item">
              <div class="ticket-header">
                <h5>
                  <i class="bi bi-ticket-detailed me-2"></i>
                  Entrada {{ i + 1 }} - {{ ticketCtrl.get('sectionName')?.value }}
                  <span *ngIf="ticketCtrl.get('ticketType')?.value" class="badge bg-info ms-2">
                    {{ ticketCtrl.get('ticketType')?.value }}
                  </span>
                  <span class="badge bg-success ms-2">
                    {{ ticketCtrl.get('price')?.value | currency:'ARS':'symbol':'1.2-2' }}
                  </span>
                </h5>
                <button 
                  type="button" 
                  (click)="removeTicket(i)" 
                  class="btn btn-outline-danger btn-sm">
                  <i class="bi bi-trash3 me-1"></i>Eliminar
                </button>
              </div>
              
              <div class="form-row">
                <div class="form-group">
                  <label for="firstName-{{i}}">Nombre:</label>
                  <input 
                    id="firstName-{{i}}" 
                    formControlName="attendeeFirstName" 
                    placeholder="Nombre del asistente" 
                    class="form-control"
                    [class.is-invalid]="ticketCtrl.get('attendeeFirstName')?.invalid && ticketCtrl.get('attendeeFirstName')?.touched">
                  <div *ngIf="ticketCtrl.get('attendeeFirstName')?.invalid && ticketCtrl.get('attendeeFirstName')?.touched" class="invalid-feedback">
                    El nombre es requerido.
                  </div>
                </div>
                
                <div class="form-group">
                  <label for="lastName-{{i}}">Apellido:</label>
                  <input 
                    id="lastName-{{i}}" 
                    formControlName="attendeeLastName" 
                    placeholder="Apellido del asistente" 
                    class="form-control"
                    [class.is-invalid]="ticketCtrl.get('attendeeLastName')?.invalid && ticketCtrl.get('attendeeLastName')?.touched">
                  <div *ngIf="ticketCtrl.get('attendeeLastName')?.invalid && ticketCtrl.get('attendeeLastName')?.touched" class="invalid-feedback">
                    El apellido es requerido.
                  </div>
                </div>
                
                <div class="form-group">
                  <label for="dni-{{i}}">DNI:</label>
                  <input 
                    id="dni-{{i}}" 
                    formControlName="attendeeDni" 
                    placeholder="DNI del asistente" 
                    class="form-control"
                    [class.is-invalid]="ticketCtrl.get('attendeeDni')?.invalid && ticketCtrl.get('attendeeDni')?.touched">
                  <div *ngIf="ticketCtrl.get('attendeeDni')?.invalid && ticketCtrl.get('attendeeDni')?.touched" class="invalid-feedback">
                    El DNI es requerido.
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="summary" *ngIf="attendeeTickets.controls.length > 0">
            <h4><i class="bi bi-receipt me-2"></i>Resumen de Compra</h4>
            
            <div class="summary-details">
              <p><i class="bi bi-person me-2"></i><strong>Usuario:</strong> ID {{ MOCK_USER_ID }} (temporal)</p>
              <p><i class="bi bi-credit-card me-2"></i><strong>Método de Pago:</strong> ID {{ MOCK_PAYMENT_METHOD_ID }} (temporal)</p>
            </div>
            
            <div class="total-amount">
              {{ calculateTotal() | currency:'ARS':'symbol':'1.2-2' }}
            </div>

            <button 
              type="submit" 
              class="btn btn-primary btn-lg" 
              [disabled]="purchaseForm.invalid || isLoading || attendeeTickets.controls.length === 0">
              <span *ngIf="isLoading" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
              <i *ngIf="!isLoading" class="bi bi-credit-card me-2"></i>
              {{ isLoading ? 'Procesando Compra...' : 'Completar Compra' }}
            </button>
          </div>
        </form>
      </ng-container>
    </div>
  </div>
</div>
